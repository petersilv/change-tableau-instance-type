{
  "StartAt": "stop_tsm",
  "States": {

    "stop_tsm": {
      "Type": "Task",
      "Next": "wait_for_tsm_stop",
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": ["${INSTANCE_ID}"],
        "Parameters": {
          "commands": [
            "tsm stop"
          ]
        },
        "TimeoutSeconds": 300
      }
    },

    "wait_for_tsm_stop": {
      "Type": "Wait",
      "Seconds": 300,
      "Next": "stop_instance"
    },

    "stop_instance": {
      "Type": "Task",
      "Next": "wait_for_stopped",
      "Resource": "arn:aws:states:::aws-sdk:ec2:stopInstances",
      "Parameters": {
        "InstanceIds": ["${INSTANCE_ID}"]
      }
    },

    "wait_for_stopped": {
      "Type": "Task",
      "Next": "change_instance_type",
      "Resource": "${LAMBDAFUNCTIONARN1}",
      "Parameters": {
        "instance_id": "${INSTANCE_ID}",
        "state": "stopped"
      }
    },

    "change_instance_type": {
      "Type": "Task",
      "Next": "start_instance",
      "Resource": "arn:aws:states:::aws-sdk:ec2:modifyInstanceAttribute",
      "Parameters": {
        "InstanceId": "${INSTANCE_ID}",
        "InstanceType": {"Value": "${INSTANCE_TYPE}"}
      }
    },

    "start_instance": {
      "Type": "Task",
      "Next": "wait_for_running",
      "Resource": "arn:aws:states:::aws-sdk:ec2:startInstances",
      "Parameters": {
        "InstanceIds": ["${INSTANCE_ID}"]
      }
    },

    "wait_for_running": {
      "Type": "Task",
      "Next": "start_tsm",
      "Resource": "${LAMBDAFUNCTIONARN1}",
      "Parameters": {
        "instance_id": "${INSTANCE_ID}",
        "state": "running"
      }
    },

    "start_tsm": {
      "Type": "Task",
      "End": true,
      "Resource": "arn:aws:states:::aws-sdk:ssm:sendCommand",
      "Parameters": {
        "DocumentName": "AWS-RunShellScript",
        "InstanceIds": ["${INSTANCE_ID}"],
        "Parameters": {
          "commands": [
            "tsm start"
          ]
        },
        "TimeoutSeconds": 1800
      }
    }

  }
}
